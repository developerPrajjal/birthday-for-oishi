<!DOCTYPE html>
<html>
<head>
  <title>Spotify Callback</title>
</head>
<body>
  <h2>Generating your playlist... please wait</h2>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const state = urlParams.get("state");
    const codeVerifier = localStorage.getItem("code_verifier");

    const redirectUri = "https://developerprajjal.github.io/birthday-for-oishi/callback.html";

    fetch("https://melody-backend-7vmo.onrender.com/api/exchange-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        code,
        codeVerifier,
        redirectUri // âœ… Important: Add this field
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.access_token) {
        localStorage.setItem("spotify_token", data.access_token);
        localStorage.setItem("selected_genres", decodeURIComponent(state));
        window.location.href = "https://developerprajjal.github.io/birthday-for-oishi/#playlist";
      } else {
        document.body.innerHTML = "<h3>Failed to retrieve access token ðŸ˜¢</h3>";
        console.error("Token error:", data);
      }
    })
    .catch(err => {
      document.body.innerHTML = "<h3>Unexpected error occurred</h3>";
      console.error("Callback error:", err);
    });
  </script>
</body>
</html>
